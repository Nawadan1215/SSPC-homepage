<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Discordツール</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Yusei+Magic&display=swap" rel="stylesheet">
  <style>
    body { font-family: "Yusei Magic", sans-serif; margin: 0; padding: 20px; background: #f0f0f0; }
    .container { max-width: 700px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-size: 1.1em; }
    input, textarea, button { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; }
    textarea { height: 80px; resize: vertical; }
    .button-group { display: flex; gap: 10px; }
    button { background: #4285f4; color: white; border: none; cursor: pointer; }
    button:hover { background: #3267d6; }
    .stop-button { background: #f44336; }
    .stop-button:hover { background: #d32f2f; }
    #status { margin-top: 10px; color: #d32f2f; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Discordメッセージ送信ツール</h2>
    <p>スレッド・ユーザーを取得はうまく動作しない可能性があります</p>
    <div class="form-group">
      <label for="token">ユーザートークン</label>
      <input type="text" id="token" placeholder="ユーザートークンを入力" />
      <button onclick="setToken()">トークン設定</button>
    </div>
    <div class="form-group">
      <label for="guildId">サーバーID（任意）</label>
      <input type="text" id="guildId" placeholder="サーバーIDを入力" />
      <div class="button-group">
        <button onclick="getChannels()">チャンネルを取得</button>
        <button onclick="getUsers()">ユーザーを取得</button>
      </div>
    </div>
    <div class="form-group">
      <label for="channelId">チャンネルID（改行/カンマで複数入力可）</label>
      <textarea id="channelId" placeholder="例: 123456789, 987654321"></textarea>
    </div>
    <div class="form-group">
      <label for="mentionUserId">メンションするユーザーID（改行/カンマで複数入力可、任意）</label>
      <textarea id="mentionUserId" placeholder="例: 123456789, 987654321"></textarea>
    </div>
    <div class="form-group">
      <label for="message">メッセージ</label>
      <textarea id="message" placeholder="送信するメッセージ"></textarea>
    </div>
    <div class="form-group">
      <label for="repeatCount">繰り返し回数（1～100）</label>
      <input type="number" id="repeatCount" placeholder="例: 1" min="1" max="100" />
    </div>
    <div class="form-group">
      <label for="interval">送信間隔（秒、0.5～10）</label>
      <input type="number" id="interval" placeholder="例: 1" min="0.5" max="10" step="0.1" />
    </div>
    <div class="form-group">
      <label for="createThread">スレッドを作成</label>
      <input type="checkbox" id="createThread" />
      <input type="text" id="threadName" placeholder="スレッド名（任意）" />
    </div>
    <div class="button-group">
      <button onclick="sendMessage()">送信</button>
      <button onclick="stopSending()" class="stop-button">停止</button>
    </div>
    <p id="status"></p>
  </div>

  <script>
    let token = "";
    let sendInterval = null;

    function setToken() {
      token = document.getElementById("token").value.trim();
      if (token) {
        document.getElementById("status").textContent = "トークンが設定されました";
      } else {
        document.getElementById("status").textContent = "トークンを入力してください";
      }
    }

    async function getChannels() {
      const guildId = document.getElementById("guildId").value.trim();
      if (!guildId || !token) {
        document.getElementById("status").textContent = "サーバーIDとトークンを入力してください";
        return;
      }
      try {
        const response = await fetch(`https://discord.com/api/v10/guilds/${guildId}/channels`, {
          headers: { Authorization: `Bot ${token}` }
        });
        if (!response.ok) throw new Error("チャンネル取得に失敗");
        const channels = await response.json();
        const textChannels = channels
          .filter(ch => ch.type === 0)
          .map(ch => ({ id: ch.id, name: ch.name }));
        document.getElementById("channelId").value = textChannels.map(ch => ch.id).join("\n");
        document.getElementById("status").textContent = "チャンネル一覧を取得しました";
      } catch (error) {
        document.getElementById("status").textContent = `エラー: ${error.message}`;
      }
    }

    async function getUsers() {
      const guildId = document.getElementById("guildId").value.trim();
      if (!guildId || !token) {
        document.getElementById("status").textContent = "サーバーIDとトークンを入力してください";
        return;
      }
      try {
        const response = await fetch(`https://discord.com/api/v10/guilds/${guildId}/members?limit=1000`, {
          headers: { Authorization: `Bot ${token}` }
        });
        if (!response.ok) throw new Error("ユーザー取得に失敗");
        const members = await response.json();
        document.getElementById("mentionUserId").value = members.map(m => m.user.id).join("\n");
        document.getElementById("status").textContent = "ユーザー一覧を取得しました";
      } catch (error) {
        document.getElementById("status").textContent = `エラー: ${error.message}`;
      }
    }

    async function sendMessage() {
      const channelIds = document.getElementById("channelId").value.split(/[\n,]+/).map(id => id.trim()).filter(id => id);
      const message = document.getElementById("message").value.trim();
      const mentionUserIds = document.getElementById("mentionUserId").value.split(/[\n,]+/).map(id => `<@${id.trim()}>`).filter(id => id);
      const repeatCount = parseInt(document.getElementById("repeatCount").value) || 1;
      const interval = parseFloat(document.getElementById("interval").value) * 1000 || 1000;
      const createThread = document.getElementById("createThread").checked;
      const threadName = document.getElementById("threadName").value.trim() || "New Thread";

      if (!channelIds.length || !message || !token) {
        document.getElementById("status").textContent = "チャンネルID、メッセージ、トークンを入力してください";
        return;
      }
      if (repeatCount > 100 || interval < 500) {
        document.getElementById("status").textContent = "回数(1-100)または間隔(0.5秒以上)を確認してください";
        return;
      }

      document.getElementById("status").textContent = "送信中...";
      if (sendInterval) clearInterval(sendInterval);

      let sentCount = 0;
      sendInterval = setInterval(async () => {
        if (sentCount < repeatCount) {
          for (const channelId of channelIds) {
            try {
              const payload = {
                content: `${mentionUserIds.join(" ")} ${message}`,
              };
              if (createThread) {
                const threadResponse = await fetch(`https://discord.com/api/v10/channels/${channelId}/threads`, {
                  method: "POST",
                  headers: { Authorization: `Bot ${token}`, "Content-Type": "application/json" },
                  body: JSON.stringify({ name: threadName, auto_archive_duration: 1440 })
                });
                const thread = await threadResponse.json();
                await fetch(`https://discord.com/api/v10/channels/${thread.id}/messages`, {
                  method: "POST",
                  headers: { Authorization: `Bot ${token}`, "Content-Type": "application/json" },
                  body: JSON.stringify(payload)
                });
              } else {
                await fetch(`https://discord.com/api/v10/channels/${channelId}/messages`, {
                  method: "POST",
                  headers: { Authorization: `Bot ${token}`, "Content-Type": "application/json" },
                  body: JSON.stringify(payload)
                });
              }
              document.getElementById("status").textContent = `送信中... (${sentCount + 1}/${repeatCount})`;
            } catch (error) {
              document.getElementById("status").textContent = `エラー: ${error.message}`;
              clearInterval(sendInterval);
            }
          }
          sentCount++;
        } else {
          clearInterval(sendInterval);
          sendInterval = null;
          document.getElementById("status").textContent = "送信完了!";
        }
      }, interval);
    }

    function stopSending() {
      if (sendInterval) {
        clearInterval(sendInterval);
        sendInterval = null;
        document.getElementById("status").textContent = "送信を停止しました";
      }
    }

    document.querySelectorAll("button, input, textarea").forEach(el => el.setAttribute("tabindex", "0"));
  </script>
